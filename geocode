#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from configparser import ConfigParser
from os import path
from os import environ

if path.exists('./config/wsgi.cfg'):
    config = ConfigParser()
    config.read('./config/wsgi.cfg')

    for key in config['env']:
        environ[key.upper()] = config['env'][key]

import sys
sys.path.insert(0, environ['GEOCODE_DIR'])

def carregar_ambiente_virtual():
    activate_this = path.join(environ['GEOCODE_DIR'], 'venv/bin/activate_this.py')
    with open(activate_this) as file_:
        exec(file_.read(), dict(__file__ = activate_this))


# Apaga base se executar da linha de comando.
if __name__ == '__main__':
    import click
    @click.command(name = 'geocode')
    @click.option('--rebuild', is_flag = True, help = 'Reconstroi base de dados de busca.')
    def comando(rebuild):
        """Executando geocode em linha de comando para iniciar geocode localmente em modo DEBUG."""
        if rebuild:
            from modelos import apagar_base, criar_base
            apagar_base()
            criar_base()
        print('Iniciando servidor localmente em modo DEBUG...')
        carregar_ambiente_virtual()
        from app import create_app
        app = create_app()
        app.run(debug = True)

    comando()

else:
    carregar_ambiente_virtual()
    from app import create_app
    application = create_app()

